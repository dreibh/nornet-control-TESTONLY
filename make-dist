#!/bin/sh -e

. ./debian.conf


CHANGELOG_HEADER="`head -n1 debian/changelog`"
PACKAGE=`echo $CHANGELOG_HEADER | sed -e "s/(.*//" -e "s/ //g"`
UPSTREAM_VERSION=`echo $CHANGELOG_HEADER | sed -e "s/[a-Z0-9 ]*(//" -e "s/).*//" -e "s/[0-9]*$//" -e "s/ //g" -e "s/^[0-9]*://" -e "s/-[^ ]*$//g"`

echo "######################################################################"
echo "CHANGELOG_HEADER:   $CHANGELOG_HEADER"
echo "PACKAGE:            $PACKAGE"
echo "UPSTREAM_VERSION:   $UPSTREAM_VERSION"
echo "######################################################################"


if [ -e $PACKAGE-$UPSTREAM_VERSION ] ; then
   rm -rf $PACKAGE-$UPSTREAM_VERSION
fi
mkdir $PACKAGE-$UPSTREAM_VERSION || exit 1


# ---------------------------------------------------------
mkdir $PACKAGE-$UPSTREAM_VERSION/src
cp NEWS README BUGS COPYING ChangeLog *.lsm $PACKAGE-$UPSTREAM_VERSION
cp src/*.py $PACKAGE-$UPSTREAM_VERSION
cp src/*.1 $PACKAGE-$UPSTREAM_VERSION
cp src/*-config $PACKAGE-$UPSTREAM_VERSION
mkdir $PACKAGE-$UPSTREAM_VERSION/cron-apt
cp src/cron-apt/5-install $PACKAGE-$UPSTREAM_VERSION/cron-apt/
mkdir $PACKAGE-$UPSTREAM_VERSION/grub
cp src/grub/*_theme $PACKAGE-$UPSTREAM_VERSION/grub/
cp src/grub/grub-defaults $PACKAGE-$UPSTREAM_VERSION/grub/
cp src/grub/*.jpeg $PACKAGE-$UPSTREAM_VERSION/grub/
mkdir $PACKAGE-$UPSTREAM_VERSION/pbuilder
cp src/pbuilder/pbuilderrc $PACKAGE-$UPSTREAM_VERSION/pbuilder/
cp src/Routing-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/Tunnelbox-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/check_* $PACKAGE-$UPSTREAM_VERSION
cp src/Make-*-Configuration $PACKAGE-$UPSTREAM_VERSION
cp src/Reset-Networking $PACKAGE-$UPSTREAM_VERSION
# ---------------------------------------------------------


tar czvf $PACKAGE-$UPSTREAM_VERSION.tar.gz $PACKAGE-$UPSTREAM_VERSION
rm -rf $PACKAGE-$UPSTREAM_VERSION
