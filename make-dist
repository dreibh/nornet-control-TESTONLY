#!/bin/bash -e

. ./debian.conf


CHANGELOG_HEADER="`head -n1 debian/changelog`"
PACKAGE=`echo $CHANGELOG_HEADER | sed -e "s/(.*//" -e "s/ //g"`
UPSTREAM_VERSION=`echo $CHANGELOG_HEADER | sed -e "s/[a-zA-Z0-9 \-]*(//" -e "s/).*//" -e "s/[0-9]*$//" -e "s/ //g" -e "s/^[0-9]*://" -e "s/-[^ ]*$//g"`

echo "######################################################################"
echo "CHANGELOG_HEADER:   $CHANGELOG_HEADER"
echo "PACKAGE:            $PACKAGE"
echo "UPSTREAM_VERSION:   $UPSTREAM_VERSION"
echo "######################################################################"


if [ -e $PACKAGE-$UPSTREAM_VERSION ] ; then
   rm -rf $PACKAGE-$UPSTREAM_VERSION
fi
mkdir $PACKAGE-$UPSTREAM_VERSION || exit 1


# ---------------------------------------------------------
mkdir $PACKAGE-$UPSTREAM_VERSION/src
cp NEWS README BUGS COPYING ChangeLog *.lsm $PACKAGE-$UPSTREAM_VERSION
cp src/*.py $PACKAGE-$UPSTREAM_VERSION
cp src/*.[0-9] $PACKAGE-$UPSTREAM_VERSION
cp src/*-config* $PACKAGE-$UPSTREAM_VERSION
cp src/*-constants $PACKAGE-$UPSTREAM_VERSION
cp src/*-authorized_keys $PACKAGE-$UPSTREAM_VERSION
cp src/*-config.example $PACKAGE-$UPSTREAM_VERSION

cp src/Random-Sleep $PACKAGE-$UPSTREAM_VERSION
cp src/Tunnelbox-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/Probe-Interface-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/Probe-Endpoint-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/Watchdog $PACKAGE-$UPSTREAM_VERSION
cp src/Server-Watchdog $PACKAGE-$UPSTREAM_VERSION
cp src/System-Backup $PACKAGE-$UPSTREAM_VERSION
cp src/System-Info $PACKAGE-$UPSTREAM_VERSION
cp src/System-Maintenance $PACKAGE-$UPSTREAM_VERSION
cp src/Start-VSystem $PACKAGE-$UPSTREAM_VERSION
cp src/Stop-VSystem $PACKAGE-$UPSTREAM_VERSION
cp src/Check-VSystem $PACKAGE-$UPSTREAM_VERSION
cp src/Show-VSystems $PACKAGE-$UPSTREAM_VERSION
cp src/Make-VSystem-Template $PACKAGE-$UPSTREAM_VERSION
cp src/Backup-VSystem $PACKAGE-$UPSTREAM_VERSION
cp src/Reset-VSystem $PACKAGE-$UPSTREAM_VERSION
cp src/Backup-All-VSystems $PACKAGE-$UPSTREAM_VERSION
cp src/Auto-Update-BootCD $PACKAGE-$UPSTREAM_VERSION
cp src/Auto-Update-Keys $PACKAGE-$UPSTREAM_VERSION
cp src/Change-VSystem-CDImage $PACKAGE-$UPSTREAM_VERSION
cp src/check_* $PACKAGE-$UPSTREAM_VERSION
cp src/Make-*-Configuration $PACKAGE-$UPSTREAM_VERSION
cp src/Tunnelbox-NAT-Helper $PACKAGE-$UPSTREAM_VERSION
cp src/Tunnelbox-Bootstrap-Helper $PACKAGE-$UPSTREAM_VERSION
cp src/Interface-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/Server-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/Node-Setup $PACKAGE-$UPSTREAM_VERSION
cp src/Convert-HDD-Images $PACKAGE-$UPSTREAM_VERSION
cp src/Set-OVF-Type $PACKAGE-$UPSTREAM_VERSION
cp src/Reset-Networking $PACKAGE-$UPSTREAM_VERSION
cp src/Check-Research-Node $PACKAGE-$UPSTREAM_VERSION
cp src/Check-Nodes $PACKAGE-$UPSTREAM_VERSION
cp src/Check-Nodes-Loop $PACKAGE-$UPSTREAM_VERSION
cp src/Clear-SSH-Node-Key $PACKAGE-$UPSTREAM_VERSION
cp src/Get-Nodes $PACKAGE-$UPSTREAM_VERSION
cp src/Get-Slice-Nodes $PACKAGE-$UPSTREAM_VERSION
cp src/Get-Users $PACKAGE-$UPSTREAM_VERSION
cp src/Get-Sites $PACKAGE-$UPSTREAM_VERSION
cp src/Get-Slices $PACKAGE-$UPSTREAM_VERSION
cp src/Get-NorNet-Configuration $PACKAGE-$UPSTREAM_VERSION
cp src/nornetinfogenerator $PACKAGE-$UPSTREAM_VERSION
cp src/Test-NTP-Configuration $PACKAGE-$UPSTREAM_VERSION
cp src/Fingerprint-SSH-Node-Keys $PACKAGE-$UPSTREAM_VERSION
cp src/Create-New-SSH-Node-Keys $PACKAGE-$UPSTREAM_VERSION

echo "NorNet $UPSTREAM_VERSION, packaged `env LANG=en date`" >$PACKAGE-$UPSTREAM_VERSION/nornet-version

mkdir $PACKAGE-$UPSTREAM_VERSION/cron-apt
cp src/cron-apt/5-install $PACKAGE-$UPSTREAM_VERSION/cron-apt/

mkdir $PACKAGE-$UPSTREAM_VERSION/XDM
cp src/XDM/Xsetup     $PACKAGE-$UPSTREAM_VERSION/XDM/
cp src/XDM/Xresources $PACKAGE-$UPSTREAM_VERSION/XDM/

mkdir $PACKAGE-$UPSTREAM_VERSION/background
cp src/background/*.png $PACKAGE-$UPSTREAM_VERSION/background/
cp src/background/*.xcf $PACKAGE-$UPSTREAM_VERSION/background/

mkdir $PACKAGE-$UPSTREAM_VERSION/grub
cp src/grub/*_theme $PACKAGE-$UPSTREAM_VERSION/grub/
cp src/grub/grub-defaults $PACKAGE-$UPSTREAM_VERSION/grub/

# ~~~~~~ Image conversion ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
SPLASH_DIMENSIONS=1024x768
DESKTOP_DIMENSIONS_LIST="1024x768 1920x1080"
QUALITY=92.5

splashWidth=`echo "$SPLASH_DIMENSIONS" | sed -e "s/^\([0-9]*\)x\(.*\)$/\1/g"`
convert -background Gold -fill "#02266b" -font Helvetica-Bold -pointsize 24 -gravity Center -size ${splashWidth}x42 \
   caption:"`cat $PACKAGE-$UPSTREAM_VERSION/nornet-version`" \
   "$PACKAGE-$UPSTREAM_VERSION/grub/caption.png"

for name in Management1 PLC1 Node1 Node2 Tunnelbox1 Monitor1 Display1 Server1 FileSrv1 Development1 Gatekeeper1 WebSrv1 WikiSrv1 Database1 TimeSrv1 ; do
   (
      echo "Processing $name ..."

      # ~~~~~~ Boot splash ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      aspectRatio=`echo "$SPLASH_DIMENSIONS" | sed -e "s/x/\//g" | bc -l`
      src/image-resize-with-cropping \
         src/background/original/Background-${name}.jpeg \
         src/background/Splash-${name}.png \
         $aspectRatio && \
      convert -size ${SPLASH_DIMENSIONS} xc:skyblue \
          \( src/background/Splash-${name}.png -resize ${SPLASH_DIMENSIONS} \) -gravity center -composite \
          \( $PACKAGE-$UPSTREAM_VERSION/background/NorNet-InformationText.png -resize ${SPLASH_DIMENSIONS} \) -gravity center -composite \
          \( "$PACKAGE-$UPSTREAM_VERSION/grub/caption.png" \) -gravity South -composite \
          -quality ${QUALITY} \
          $PACKAGE-$UPSTREAM_VERSION/grub/Splash-${name}-${SPLASH_DIMENSIONS}.jpeg
      exiftool -q -overwrite_original -Copyright="Copyright `date '+%Y'` by Thomas Dreibholz" \
          $PACKAGE-$UPSTREAM_VERSION/grub/Splash-${name}-${SPLASH_DIMENSIONS}.jpeg && \
      rm src/background/Splash-${name}.png

      # ~~~~~~ Desktop background ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      for desktopDimensions in $DESKTOP_DIMENSIONS_LIST ; do
         aspectRatio=`echo "$desktopDimensions" | sed -e "s/x/\//g" | bc -l`
         src/image-resize-with-cropping \
            src/background/original/Background-${name}.jpeg \
            src/background/Desktop-${name}.png \
            $aspectRatio && \
         convert -size ${desktopDimensions} xc:skyblue \
            \( src/background/Desktop-${name}.png -resize ${desktopDimensions} \) -gravity center -composite \
            \( $PACKAGE-$UPSTREAM_VERSION/background/NorNet-InformationText.png -resize ${desktopDimensions} \) -gravity center -composite \
            -interlace line -quality ${QUALITY} \
            $PACKAGE-$UPSTREAM_VERSION/background/Desktop-${name}-${desktopDimensions}.jpeg && \
         exiftool -q -overwrite_original -Copyright="Copyright `date '+%Y'` by Thomas Dreibholz" \
            $PACKAGE-$UPSTREAM_VERSION/background/Desktop-${name}-${desktopDimensions}.jpeg && \
         rm src/background/Desktop-${name}.png
      done

   ) &
   
done
wait
rm -f "$PACKAGE-$UPSTREAM_VERSION/grub/caption.png"
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

mkdir $PACKAGE-$UPSTREAM_VERSION/pbuilder
cp src/pbuilder/pbuilderrc $PACKAGE-$UPSTREAM_VERSION/pbuilder/

mkdir $PACKAGE-$UPSTREAM_VERSION/vsystems
cp src/vsystems/EXAMPLE-* $PACKAGE-$UPSTREAM_VERSION/vsystems/

mkdir $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter
cp src/Kontrollsenter/NorNet-*.css src/Kontrollsenter/NorNet-*.js src/Kontrollsenter/NorNet-*.php src/Kontrollsenter/NorNet-*.html src/Kontrollsenter/Forward-*.html $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter

mkdir $PACKAGE-$UPSTREAM_VERSION/Monitor
cp src/Monitor/*.cfg $PACKAGE-$UPSTREAM_VERSION/Monitor/

mkdir $PACKAGE-$UPSTREAM_VERSION/WebServer
cp src/WebServer/000-*.conf $PACKAGE-$UPSTREAM_VERSION/WebServer/
cp src/WebServer/*-awstats.conf $PACKAGE-$UPSTREAM_VERSION/WebServer/
cp src/WebServer/make-certificate $PACKAGE-$UPSTREAM_VERSION/WebServer/
cp src/WebServer/make-cipher-suites $PACKAGE-$UPSTREAM_VERSION/WebServer/
cp src/WebServer/favicon.ico $PACKAGE-$UPSTREAM_VERSION/WebServer/
cp src/WebServer/nntb.config $PACKAGE-$UPSTREAM_VERSION/WebServer/

mkdir $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/Clock
cp -r src/Kontrollsenter/Clock/station-clock.svg $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/Clock/
cp -r src/Kontrollsenter/Clock/License.pdf $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/Clock/
mkdir $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/ol3-layerswitcher/
mkdir $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/ol3-layerswitcher/src/
cp -r src/Kontrollsenter/ol3-layerswitcher/src/ol3-layerswitcher.js  $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/ol3-layerswitcher/src/
cp -r src/Kontrollsenter/ol3-layerswitcher/src/ol3-layerswitcher.css $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/ol3-layerswitcher/src/
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Backgrounds
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Control
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Flags
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Icons
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Markers

mkdir $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook
cp -r src/Kontrollsenter/UnifrakturCook/FontLog.txt              $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/
cp -r src/Kontrollsenter/UnifrakturCook/OFL-FAQ.txt              $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/
cp -r src/Kontrollsenter/UnifrakturCook/OFL.txt                  $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/
cp -r src/Kontrollsenter/UnifrakturCook/UnifrakturCook-Light.ttf $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/
cp -r src/Kontrollsenter/UnifrakturCook/UnifrakturCook.ttf       $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/
mkdir $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/sources
cp -r src/Kontrollsenter/UnifrakturCook/sources/UnifrakturCook-Light.sfd $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/sources/
cp -r src/Kontrollsenter/UnifrakturCook/sources/UnifrakturCook.sfd       $PACKAGE-$UPSTREAM_VERSION/Kontrollsenter/UnifrakturCook/sources/

mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Sites
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Sites/Original
cp -r src/Artwork/Sites/Original/*.jpeg $PACKAGE-$UPSTREAM_VERSION/Artwork/Sites/Original/
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Sites/Small
mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Sites/Large
inputFiles=`find $PACKAGE-$UPSTREAM_VERSION/Artwork/Sites/Original/ -name "*.jpeg" -printf '%p\n'`

OIFS=$IFS
IFS='
'
cores=$(grep -c ^processor /proc/cpuinfo 2>/dev/null || grep -c ^processor /compat/linux/proc/cpuinfo 2>/dev/null || echo "1" )
processes=0
for inputFile in $inputFiles ; do
   outputFileSmall="`echo "$inputFile" | sed -e "s/\/Original\//\/Small\//g"`"
   outputFileLarge="`echo "$inputFile" | sed -e "s/\/Original\//\/Large\//g"`"
   inputFileTMP="$inputFile.tmp.png"
   echo "Converting $inputFile ..."
   (
      src/image-resize-with-cropping "$inputFile" "$inputFileTMP" 1.333333
      convert "$inputFileTMP" -resize 512x  -interlace line -quality 92.5 "$outputFileSmall"
      convert "$inputFileTMP" -resize 2048x -interlace line -quality 92.5 "$outputFileLarge"
      rm -f "$inputFileTMP"
   ) &
   let processes=$processes+1
   if [ $processes -ge $cores ] ; then
      wait
      processes=0
   fi
done
wait
IFS=$OIFS

cp -r src/Artwork/Graphics/Backgrounds/*.png $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Backgrounds/
cp -r src/Artwork/Graphics/Control/*.png $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Control/
cp -r src/Artwork/Graphics/Flags/*.png $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Flags/
cp -r src/Artwork/Graphics/Flags/*.svg $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Flags/
cp -r src/Artwork/Graphics/Icons/*.png $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Icons/
cp -r src/Artwork/Graphics/Markers/*.svg $PACKAGE-$UPSTREAM_VERSION/Artwork/Graphics/Markers/

mkdir $PACKAGE-$UPSTREAM_VERSION/Artwork/Desktop
mv $PACKAGE-$UPSTREAM_VERSION/background/Desktop-*.jpeg $PACKAGE-$UPSTREAM_VERSION/Artwork/Desktop/
# ---------------------------------------------------------

tar czvf $PACKAGE-$UPSTREAM_VERSION.tar.gz $PACKAGE-$UPSTREAM_VERSION
rm -rf $PACKAGE-$UPSTREAM_VERSION
