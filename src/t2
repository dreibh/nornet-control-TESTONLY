#!/bin/bash

CONFIG_DIRECTORY="c"
ACTIVE_DIRECTORY="a"


# ###### Load interface configuration from configuration file ###############
load-interface-configuration ()
{
   CONFIG="$1"

   # ====== Load the settings ===============================================
   TYPE=""
   PRECEDENCE=""
   TOS=""
   LOCAL_PROVIDER_SHORT=""
   LOCAL_PROVIDER_LONG=""
   LOCAL_INNER_ADDRESS=""
   LOCAL_OUTER_ADDRESS=""
   INNER_PREFIX=
   OUTER_PREFIX=
   REMOTE_PROVIDER_SHORT=""
   REMOTE_PROVIDER_LONG=""
   REMOTE_INNER_ADDRESS=""
   REMOTE_OUTER_ADDRESS=""
   
   if [ ! -e "$CONFIG_DIRECTORY/$config" ] ; then
      echo 2>&1 "ERROR: Cannot find $CONFIG_DIRECTORY/$config!"
      exit 1
   fi
   . $CONFIG_DIRECTORY/$config
   
   # ====== Check the input =================================================
   if [[ ! "$TYPE" =~ ^gre$|^seks$ ]] ; then
      echo 2>&1 "ERROR: Bad interface TYPE setting in $CONFIG: ${TYPE}!"
      exit 1
   fi
   if [[ ! "$PRECEDENCE" =~ ^[0-9]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface PRECEDENCE setting in $CONFIG: ${PRECEDENCE}!"
      exit 1
   fi
   if [[ ! "$TOS" =~ ^0x[0-9a-f]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface TOS setting in $CONFIG: ${TOS}!"
      exit 1
   fi
   if [[ ! "$LOCAL_INNER_ADDRESS" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$|^[0-9a-fA-F:]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface LOCAL_INNER_ADDRESS setting in $CONFIG: ${LOCAL_INNER_ADDRESS}!"
      exit 1
   fi
   if [[ ! "$INNER_PREFIX" =~ ^[0-9]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface INNER_PREFIX setting in $CONFIG: ${INNER_PREFIX}!"
      exit 1
   fi
   if [[ ! "$LOCAL_OUTER_ADDRESS" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$|^[0-9a-fA-F:]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface LOCAL_OUTER_ADDRESS setting in $CONFIG: ${LOCAL_OUTER_ADDRESS}!"
      exit 1
   fi
   if [[ ! "$OUTER_PREFIX" =~ ^[0-9]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface OUTER_PREFIX setting in $CONFIG: ${OUTER_PREFIX}!"
      exit 1
   fi
   if [[ ! "$REMOTE_INNER_ADDRESS" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$|^[0-9a-fA-F:]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface REMOTE_INNER_ADDRESS setting in $CONFIG: ${REMOTE_INNER_ADDRESS}!"
      exit 1
   fi
   if [[ ! "$REMOTE_OUTER_ADDRESS" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$|^[0-9a-fA-F:]+$ ]] ; then
      echo 2>&1 "ERROR: Bad interface REMOTE_OUTER_ADDRESS setting in $CONFIG: ${REMOTE_OUTER_ADDRESS}!"
      exit 1
   fi
   if [ "$LOCAL_PROVIDER_SHORT" = "" ] ; then
      echo 2>&1 "ERROR: Missing LOCAL_PROVIDER_SHORT setting in $CONFIG!"
      exit 1
   fi
   if [ "$LOCAL_PROVIDER_LONG" = "" ] ; then
      echo 2>&1 "ERROR: Missing LOCAL_PROVIDER_LONG setting in $CONFIG!"
      exit 1
   fi
   if [ "$REMOTE_PROVIDER_SHORT" = "" ] ; then
      echo 2>&1 "ERROR: Missing REMOTE_PROVIDER_SHORT setting in $CONFIG!"
      exit 1
   fi
   if [ "$REMOTE_PROVIDER_LONG" = "" ] ; then
      echo 2>&1 "ERROR: Missing REMOTE_PROVIDER_LONG setting in $CONFIG!"
      exit 1
   fi
}


# ###### Activate interface #################################################
activateInterface ()
{
   load-interface-configuration "$1"
   cp "$CONFIG_DIRECTORY/$CONFIG" "$ACTIVE_DIRECTORY/$CONFIG"
}


# ###### Deactivate interface ###############################################
deactivateInterface ()
{
   load-interface-configuration "$1"
   rm -f "$ACTIVE_DIRECTORY/$CONFIG"
}




ALL_CONFIGS=`find "$CONFIG_DIRECTORY" -name '*[0-9]-[0-9]*-*[0-9]' -printf "%f\n\n" `
for config in $ALL_CONFIGS ; do
  echo "C=$config"
  if [ ! -e "$ACTIVE_DIRECTORY/$config" ] ; then
     echo "NEW."

     activateInterface "$config"
     
     
  else
     echo "Already active."
     if ! diff "$CONFIG_DIRECTORY/$config" "$ACTIVE_DIRECTORY/$config" >/dev/null ; then
        echo "DIFF!"
        deactivateInterface "$config"
        activateInterface "$config"
     fi
  fi
done
