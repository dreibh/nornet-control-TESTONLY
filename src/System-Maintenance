#!/bin/bash -e

# Update package repositories
echo "Updating package repositories ..."
sudo apt-get update -qq

# Fixes
echo "Applying package fixes, if necessary ..."
sudo dpkg --configure -a  >/tmp/install.log 2>&1 &
wait
cat /tmp/install.log
sudo nohup apt-get install -f -y -q  >/tmp/install.log 2>&1 &
wait
cat /tmp/install.log

# Remove obsolete kernel packages
echo "Removing obsolete kernels ..."
ktype=$(uname -r | sed 's/.*-\(generic\|i386\|server\|common\|rt\|xen\|ec2\)/\1/')
sudo nohup apt-get remove -y -qq --purge 'linux-(headers|image)-.*' linux-headers-$(uname -r)+ linux-headers-$(uname -r | sed s/-$ktype//)+ linux-headers-$ktype+ linux-image-$(uname -r)+ linux-image-$ktype+ linux-$ktype+ >/tmp/install.log 2>&1 &
wait
cat /tmp/install.log

# System update
echo "Installing updates ..."
sudo nohup apt-get dist-upgrade -y -q >/tmp/install.log 2>&1 &
wait
cat /tmp/install.log

echo "Cleaning up ..."
sudo apt-get autoremove -y -q >/tmp/install.log 2>&1 &
wait
cat /tmp/install.log
sudo apt-get clean

# Cache updates
echo "Updating caches ..."
sudo apt-file update >/dev/null
sudo updatedb
