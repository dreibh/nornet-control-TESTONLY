#!/bin/bash -e
#
# Build NorNet Kernel Repository
# Copyright (C) 2017-2019 by Thomas Dreibholz
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
# Contact: dreibh@simula.no
#

XENIAL_KERNEL_DEBS=/storage/mptcp-kernels/xenial-deb
BIONIC_KERNEL_DEBS=/storage/mptcp-kernels/bionic-deb

LOCAL_KERNEL_REPO=/storage/mptcp-kernels/ubuntu
PUBLIC_KERNEL_REPO=nornetpp@nfs.simula.nornet:/nfs/adm/packages/nornet-kernel/ubuntu/


# How to add repository:
# sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys DF605BB0760F2D65
# Add to sources.list (for Ubuntu 18.04):
# deb https://packages.nntb.no/nornet-kernel/ubuntu/ bionic bionic-kernel
# deb-src https://packages.nntb.no/nornet-kernel/ubuntu/ bionic bionic-kernel
# Add to sources.list (for Ubuntu 16.04):
# deb https://packages.nntb.no/nornet-kernel/ubuntu/ xenial xenial-kernel
# deb-src https://packages.nntb.no/nornet-kernel/ubuntu/ xenial xenial-kernel


echo "Synchronising packages for Xenial ..."
mkdir -p ${XENIAL_KERNEL_DEBS}/
rsync -Pc -e "ssh -p 50691" -Pv thomasd@dnat.simula.no:'src/*.deb' ${XENIAL_KERNEL_DEBS}/

echo "Synchronising packages for Bionic ..."
mkdir -p ${BIONIC_KERNEL_DEBS}/
rsync -Pc ~/src/linux*.deb ${BIONIC_KERNEL_DEBS}/


echo "Creating repository ..."
rm -rf ${LOCAL_KERNEL_REPO}
mkdir -p ${LOCAL_KERNEL_REPO}
mkdir -p ${LOCAL_KERNEL_REPO}/conf
cp distributions ${LOCAL_KERNEL_REPO}/conf
 

cd ${LOCAL_KERNEL_REPO}
# reprepro --ignore=undefinedtarget -C xenial-kernel includedeb xenial -C bionic-kernel includedeb bionic ${BIONIC_KERNEL_DEBS}/*.deb ${XENIAL_KERNEL_DEBS}/*.deb
reprepro --ignore=undefinedtarget -C xenial-kernel includedeb xenial ${XENIAL_KERNEL_DEBS}/*.deb
reprepro --ignore=undefinedtarget -C bionic-kernel includedeb bionic ${BIONIC_KERNEL_DEBS}/*.deb


echo "Copying to server ..."
rsync -Pav -e "ssh -J dreibh@oesthorn.nntb.no" --delete ${LOCAL_KERNEL_REPO}/ $PUBLIC_KERNEL_REPO/

echo "Done!"
