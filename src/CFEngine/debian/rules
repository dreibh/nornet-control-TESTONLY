#!/usr/bin/make -f
# vim:noet:ts=4:sw=4:

MASTERFILES_TARBALL      = $(shell ls -1 masterfiles-*.tar.xz.base64 | head -n1)
MASTERFILES_PATCH        := debian/patches/masterfiles
MASTERFILES_TEMP_DATE    := $(shell date -u +%Y%m%d%H%M%S)
MASTERFILES_TEMP_REVISION = $(shell cd $(MASTERFILES_GIT_CHECKOUT) 2>/dev/null && git rev-parse --short $(MASTERFILES_GIT_BRANCH))
MASTERFILES_TEMP_VERSION  = $(MASTERFILES_TEMP_DATE)-$(MASTERFILES_TEMP_REVISION)
MASTERFILES_TEMP_TARBALL  = masterfiles-$(MASTERFILES_TEMP_VERSION).tar.xz.base64
MASTERFILES_GIT_REPO     := https://github.com/cfengine/masterfiles.git
MASTERFILES_GIT_BRANCH   := 3.8.x
MASTERFILES_GIT_CHECKOUT := masterfiles-checkout

%:
	dh $@ --with quilt,python2

override_dh_auto_configure: masterfiles/autogen.sh
	dh_autoreconf
	./configure 	--prefix=/usr \
			--with-sql=yes \
			--with-mysql \
			--with-postgresql \
			--with-libvirt \
			--with-lmdb \
			--with-libxml2 \
			--with-workdir=/var/lib/cfengine3 \
			--with-logdir=/var/log/cfengine3 \
			--with-piddir=/var/run/cfengine3 \
			--libdir=/usr/lib/cfengine3 \
			--docdir=\$${prefix}/share/doc/cfengine3 \
			--datadir=\$${prefix}/share/cfengine3 \
			--mandir=\$${prefix}/share/man \
			CFLAGS="$(CFLAGS)" LDFLAGS="-Wl,-z,relro" \
			CPPFLAGS=-D_FORTIFY_SOURCE=2
	cd masterfiles && ./autogen.sh  --prefix=/usr/share/cfengine3 \
					--with-core=$(CURDIR)

override_dh_clean:
	dh_autoreconf_clean
	dh_clean --exclude=#008.cf# masterfiles-*.tar.xz.base64
	rm -rf masterfiles $(MASTERFILES_GIT_CHECKOUT)

override_dh_installchangelogs:
	dh_installchangelogs ChangeLog

override_dh_auto_clean:
	dh_auto_clean
	if [ -d masterfiles ]; then dh_auto_clean -Dmasterfiles; fi

override_dh_compress:
	dh_compress -X.cf

override_dh_strip:
	dh_strip --dbg-package=cfengine3-dbg

override_dh_installman:
	## Man pages are created with an undocumented flag
	/bin/mkdir -p $(CURDIR)/debian/cfengine3/usr/share/man/man8/
	for p in cf-agent cf-key cf-promises cf-runagent cf-execd cf-serverd cf-monitord; \
		do $(CURDIR)/$$p/$$p -M > $(CURDIR)/debian/cfengine3/usr/share/man/man8/$$p.8 ;\
        done
	dh_installman

override_dh_auto_install:
	dh_auto_install
	dh_auto_install -Dmasterfiles

override_dh_install:
	dh_install --exclude=examples

masterfiles/autogen.sh:
	base64 -d < $(MASTERFILES_TARBALL) | tar xfJ -

sync-masterfiles-repo:
	if [ -d $(MASTERFILES_GIT_CHECKOUT) ]; then \
		cd $(MASTERFILES_GIT_CHECKOUT) && git pull; \
	else \
		git clone -b $(MASTERFILES_GIT_BRANCH) $(MASTERFILES_GIT_REPO) $(MASTERFILES_GIT_CHECKOUT); \
	fi

$(MASTERFILES_GIT_CHECKOUT)/.git/FETCH_HEAD: sync-masterfiles-repo
	@true

create-masterfiles-tarball: $(MASTERFILES_TEMP_TARBALL)

$(MASTERFILES_TEMP_TARBALL): $(MASTERFILES_GIT_CHECKOUT)/.git/FETCH_HEAD
	cd $(MASTERFILES_GIT_CHECKOUT) && git archive --prefix=masterfiles/ --format=tar $(MASTERFILES_GIT_BRANCH) | xz -zc9 | base64 > ../$(MASTERFILES_TEMP_TARBALL)

update-masterfiles-patch: $(MASTERFILES_PATCH)

$(MASTERFILES_PATCH): $(MASTERFILES_TEMP_TARBALL)
	diff -Nu /dev/null $(MASTERFILES_TEMP_TARBALL) | sed 's/^\+\+\+ \($(MASTERFILES_TEMP_TARBALL)\)/+++ a\/\1/g' >$(MASTERFILES_PATCH)
	git commit -m"$(MASTERFILES_PATCH): Update with upstream masterfiles revision $(MASTERFILES_TEMP_REVISION)" $(MASTERFILES_PATCH)

.PHONY: sync-masterfiles-repo create-masterfiles-tarball update-masterfiles-patch
